"use client";

import { OrbitControls, TransformControls, Html } from "@react-three/drei";
import { Canvas } from "@react-three/fiber";
import React, { useRef, useState } from "react";
import CustomGrid from "./CustomGrid";
import useModelStore from "@/store/useModelStore";
import Model from "@/components/shared/Model";
import ModelPlacer from "../shared/ModelPlacer";
import * as THREE from "three";
import SnappingTransformControls from "../shared/SnappingTransformControls";
import MoveIcon from "../icons/MoveIcon";
import RotateIcon from "../icons/RotateIcon";
import SizeIcon from "../icons/SizeIcon";
import DuplicateIcon from "../icons/DuplicateIcon";
import { toFarsiNumber } from "@/helper/helper";
import DeleteIcon from "../icons/DeleteIcon";
import ModelToolbar from "../shared/ModelToolbar";

const GridPage = () => {
  const selectedModels = useModelStore((state) => state.selectedModels);
  const isAdjustingHeight = useModelStore((state) => state.isAdjustingHeight);
  const [activeModelId, setActiveModelId] = useState(null);
  const [mode, setMode] = useState("translate");
  const [rotateSnap, setRotateSnap] = useState(90);
  const modelRefs = useRef({});

  const handlePointerMissed = () => {
    setActiveModelId(null);
  };

  // آپدیت position و rotation در selectedModels
  const updateModelTransform = (modelId, newPosition, newRotation) => {
    useModelStore.setState((state) => ({
      selectedModels: state.selectedModels.map((model) =>
        model.id === modelId
          ? {
              ...model,
              position: [newPosition.x, newPosition.y, newPosition.z],
              rotation: [newRotation.x, newRotation.y, newRotation.z],
            }
          : model
      ),
    }));
  };

  return (
    <div className="w-full h-[600px] relative">
      {activeModelId && (
        <ModelToolbar
          mode={mode}
          setMode={setMode}
          rotateSnap={rotateSnap}
          setRotateSnap={setRotateSnap}
          activeModelId={activeModelId}
          setActiveModelId={setActiveModelId}
          modelRefs={modelRefs}
        />
      )}

      <Canvas
        camera={{ position: [10, 10, 10], fov: 50 }}
        onPointerMissed={handlePointerMissed}
      >
        <ambientLight intensity={1} />
        <directionalLight position={[10, 10, 10]} intensity={1.5} />

        {/* مدل‌ها */}
        {selectedModels.map((model, index) => (
          <group
            key={model.id}
            onClick={(e) => {
              e.stopPropagation();
              setActiveModelId(model.id);
            }}
          >
            <Model
              id={model.id}
              path={model.path}
              position={model.position}
              rotation={model.rotation}
              ref={(ref) => {
                modelRefs.current[model.id] = ref;
              }}
            />
          </group>
        ))}

        {/* TransformControls */}
        {activeModelId && modelRefs.current[activeModelId] && (
          <SnappingTransformControls
            object={modelRefs.current[activeModelId]}
            mode={mode}
            snap={1}
            rotateSnap={rotateSnap}
            minY={0}
            onStart={() => useModelStore.setState({ isAdjustingHeight: true })}
            onEnd={() => useModelStore.setState({ isAdjustingHeight: false })}
            onObjectChange={() => {
              const object = modelRefs.current[activeModelId];
              if (object) {
                updateModelTransform(
                  activeModelId,
                  object.position,
                  object.rotation
                );
              }
            }}
          />
        )}

        <ModelPlacer />
        <CustomGrid />
        <OrbitControls
          enableRotate={!isAdjustingHeight}
          enablePan={!isAdjustingHeight}
          enableZoom={true}
        />
      </Canvas>
    </div>
  );
};

export default GridPage;

import { TransformControls } from "@react-three/drei";
import { useFrame } from "@react-three/fiber";
import { useEffect, useRef } from "react";
import * as THREE from "three";
import useModelStore from "@/store/useModelStore";

const SnappingTransformControls = ({
  object,
  mode = "translate",
  snap = 1,
  rotateSnap = 45,
  minY = 0,
  color = "#a600ff",
  onStart = () => {},
  onEnd = () => {},
  onObjectChange = () => {}, 
}) => {
  const controlsRef = useRef();

  useFrame(() => {
    if (controlsRef.current?.dragging && object) {
      if (mode === "translate") {
        const pos = object.position;
        pos.x = Math.round(pos.x / snap) * snap;
        pos.y = Math.max(Math.round(pos.y / snap) * snap, minY);
        pos.z = Math.round(pos.z / snap) * snap;
      }

      if (mode === "rotate") {
        const rot = object.rotation;
        rot.x =
          Math.round(rot.x / (rotateSnap * (Math.PI / 180))) *
          (rotateSnap * (Math.PI / 180));
        rot.y =
          Math.round(rot.y / (rotateSnap * (Math.PI / 180))) *
          (rotateSnap * (Math.PI / 180));
        rot.z =
          Math.round(rot.z / (rotateSnap * (Math.PI / 180))) *
          (rotateSnap * (Math.PI / 180));
      }
    }
  });

  useEffect(() => {
    if (controlsRef.current) {
      const gizmo = controlsRef.current;
      gizmo.traverse((child) => {
        if (child.material) {
          // تغییر رنگ همه متریال‌ها
          child.material.color.set(color);
          child.material.needsUpdate = true;
        }
      });
    }
  }, [color, object]);

  return (
    <TransformControls
      ref={controlsRef}
      object={object}
      mode={mode}
      onMouseDown={onStart}
      onMouseUp={onEnd}
      onObjectChange={onObjectChange}
    />
  );
};

export default SnappingTransformControls;

import React, { forwardRef, useMemo } from "react";
import { useGLTF } from "@react-three/drei";

const Model = forwardRef(({ path, position, rotation }, ref) => {
  const { scene } = useGLTF(path);

  // کلون کردن scene برای ایجاد یک نمونه مستقل
  const clonedScene = useMemo(() => {
    const clone = scene.clone(true); // کپی عمیق
    clone.traverse((child) => {
      if (child.isMesh) {
        child.material = child.material.clone(); // کپی مواد برای جلوگیری از اشتراک
      }
    });
    return clone;
  }, [scene]);

  return (
    <primitive
      ref={ref}
      object={clonedScene}
      position={position}
      rotation={rotation}
      scale={100}
    />
  );
});

export default Model;

